# БАЗОВЫЕ ЗАПРОСЫ SQL
## Задача 1.
На заметку:  

Оператор FROM всегда указывается после оператора SELECT. В обратном порядке их записывать нельзя — база данных вернёт ошибку.

Задание:  

Выведите все записи из таблицы products.

Поля в результирующей таблице: product_id, name, price

``` sql
SELECT *
FROM   products
```
## Задача 2.
На заметку:

Оператор ORDER BY всегда указывается после операторов SELECT и FROM.

Задание:

Выведите все записи из таблицы products, отсортировав их по наименованиям товаров в алфавитном порядке, т.е. по возрастанию. Для сортировки используйте оператор ORDER BY.

Поля в результирующей таблице: product_id, name, price
``` sql
SELECT *
FROM   products
ORDER BY name
```
## Задача 3.
Задание:

Отсортируйте таблицу courier_actions сначала по колонке courier_id по возрастанию id курьера, потом по колонке action (снова по возрастанию), а затем по колонке time, но уже по убыванию — от самого последнего действия к самому первому. Не забудьте включить в результат колонку order_id.

Добавьте в запрос оператор LIMIT и выведите только первые 1000 строк результирующей таблицы.

Поля в результирующей таблице: courier_id, order_id, action, time
``` sql
SELECT courier_id,
       order_id,
       action,
       time
FROM   courier_actions
ORDER BY 1, 3, time desc limit 1000
```
## Задача 4.
Сейчас важно запомнить порядок записи всех известных нам ключевых слов:

1. SELECT
2. FROM
3. ORDER BY
4. LIMIT
Также важно понять, что порядок их выполнения несколько отличается от того, в какой последовательности они указываются в SQL-запросе:

Сначала выполняется оператор FROM — происходит выбор нужной таблицы.
Затем SELECT — отбираются указанные столбцы.
Потом ORDER BY — производится сортировка результирующей таблицы.
И в самом конце LIMIT — ограничивается количество выводимых записей.
Подробнее о порядке выполнения операторов мы будем ещё не раз говорить в последующих уроках. 

А сейчас давайте попробуем с помощью всех этих знаний решить несложную практическую задачу.

Задание:

Используя операторы SELECT, FROM, ORDER BY и LIMIT, определите 5 самых дорогих товаров в таблице products, которые доставляет наш сервис. Выведите их наименования и цену.

Поля в результирующей таблице: name, price


``` sql
select
  name,
  price
from
  products
ORDER BY
  price desc
limit
  5
```
## Задача 5.
Задание:

Повторите запрос из предыдущего задания, но теперь колонки name и price переименуйте соответственно в product_name и product_price.

Поля в результирующей таблице: product_name, product_price
``` sql
SELECT name product_name,
       price product_price
FROM   products
ORDER BY price desc limit 5
```
## Задача 6.
Задание:

Используя операторы SELECT, FROM, ORDER BY и LIMIT, а также функцию LENGTH, определите товар с самым длинным названием в таблице products. Выведите его наименование, длину наименования в символах, а также цену этого товара. Колонку с длиной наименования в символах назовите name_length.

Поля в результирующей таблице: name, name_length, price
``` sql
SELECT name,
       length(name) as name_length,
       price
FROM   products
ORDER BY 2 desc limit 1
```
## Задача 7.
Задание:

Примените последовательно функции UPPER и SPLIT_PART к колонке name и преобразуйте наименования товаров в таблице products так, чтобы от названий осталось только первое слово, записанное в верхнем регистре. Колонку с новым названием, состоящим из первого слова, назовите first_word.

В результат включите исходные наименования товаров, новые наименования из первого слова, а также цену товаров. Результат отсортируйте по возрастанию исходного наименования товара в колонке name.

Поля в результирующей таблице: name, first_word, price
``` sql
SELECT name,
       upper(split_part(name, ' ', 1)) as first_word,
       price
FROM   products
ORDER BY name
```
## Задача 8.
Задание:

Измените тип колонки price из таблицы products на VARCHAR. Выведите колонки с наименованием товаров, ценой в исходном формате и ценой в формате VARCHAR. Новую колонку с ценой в новом формате назовите price_char.

Результат отсортируйте по возрастанию исходного наименования товара в колонке name. Количество выводимых записей не ограничивайте.

Поле в результирующей таблице: name, price, price_char
``` sql
SELECT name,
       price,
       price::varchar as price_char
FROM   products
ORDER BY name
```
## Задача 9.

Задание:

Для первых 200 записей из таблицы orders выведите информацию в следующем виде (обратите внимание на пробелы):

Заказ № [id_заказа] создан [дата]

Полученную колонку назовите order_info.

Пример вывода:

Заказ № 65 создан 2022-09-01


Пояснение:

При указании текстовых значений используйте одинарные кавычки.

Чтобы извлечь дату из значений в колонке creation_time, достаточно применить к ней функцию DATE или изменить её тип на DATE
``` sql
SELECT concat('Заказ № ', order_id, ' создан ', creation_time::date) as order_info
FROM   orders limit 200
```
## Задача 10.
Задание:

Выведите id всех курьеров и их годы рождения из таблицы couriers.

Год рождения необходимо получить из колонки birth_date. Новую колонку с годом назовите birth_year. Результат отсортируйте сначала по убыванию года рождения курьера (т.е. от самых младших к самым старшим), затем по возрастанию id курьера.

Поля в результирующей таблице: courier_id, birth_year
``` sql
SELECT courier_id,
       date_part('year', birth_date) as birth_year
FROM   couriers
ORDER BY birth_year desc, courier_id
```
## * Задача 11.
Задание:

Как и в предыдущем задании, снова выведите id всех курьеров и их годы рождения, только теперь к извлеченному году примените функцию COALESCE. Укажите параметры функции так, чтобы вместо NULL значений в результат попадало текстовое значение unknown. Названия полей оставьте прежними.

Отсортируйте итоговую таблицу сначала по убыванию года рождения курьера, затем по возрастанию id курьера.

Поля в результирующей таблице: courier_id, birth_year

Пояснение:

При указании текстового значения используйте одинарные кавычки, как в примерах выше.

Не забудьте учесть, что unknown — значение типа VARCHAR, а значит, извлечённый из даты год нужно тоже привести к этому типу. Поэтому сначала извлеките год, затем преобразуйте его в текст и далее применяйте к полученному значению функцию COALESCE.
``` sql
SELECT courier_id,
       COALESCE(date_part('year', birth_date)::varchar, 'unknown') as birth_year
FROM   couriers
ORDER BY birth_year desc, courier_id
```
## Задача 12.
Задание:

Давайте представим, что по какой-то необъяснимой причине мы вдруг решили в одночасье повысить цену всех товаров в таблице products на 5%.

Выведите id и наименования всех товаров, их старую и новую цену. Колонку со старой ценой назовите old_price, а колонку с новой — new_price.

Результат отсортируйте сначала по убыванию новой цены, затем по возрастанию id товара.

Поля в результирующей таблице: product_id, name, old_price, new_price
``` sql
SELECT product_id,
       name,
       price as old_price,
       price * 1.05 as new_price
FROM   products
ORDER BY new_price desc, product_id
```
## Задача 13.
Задание:

Вновь, как и в прошлом задании, повысьте цену всех товаров на 5%, только теперь к колонке с новой ценой примените функцию ROUND. Выведите id и наименования товаров, их старую цену, а также новую цену с округлением. Новую цену округлите до одного знака после запятой, но тип данных не меняйте.

Результат отсортируйте сначала по убыванию новой цены, затем по возрастанию id товара.

Поля в результирующей таблице: product_id, name, old_price, new_price
``` sql
SELECT product_id,
       name,
       price as old_price,
       round(price * 1.05, 1) as new_price
FROM   products
ORDER BY new_price desc, product_id
```
## Задача 14.
Задание:

Повысьте цену на 5% только на те товары, цена которых превышает 100 рублей. Цену остальных товаров оставьте без изменений. Также не повышайте цену на икру, которая и так стоит 800 рублей. Выведите id и наименования всех товаров, их старую и новую цену. Цену округлять не нужно.

Результат отсортируйте сначала по убыванию новой цены, затем по возрастанию id товара.

Поля в результирующей таблице: product_id, name, old_price, new_price
``` sql
SELECT product_id,
       name,
       price as old_price,
       case when name = 'икра' then price
            when price > 100 then price * 1.05
            else price end as new_price
FROM   products
ORDER BY new_price desc, product_id
```
## Задача 15.
Задание:

Вычислите НДС каждого товара в таблице products и рассчитайте цену без учёта НДС. Выведите всю информацию о товарах, включая сумму налога и цену без его учёта. Колонки с суммой налога и ценой без НДС назовите соответственно tax и price_before_tax. Округлите значения в этих колонках до двух знаков после запятой.

Результат отсортируйте сначала по убыванию цены товара без учёта НДС, затем по возрастанию id товара.

Поля в результирующей таблице: product_id, name, price, tax, price_before_tax
``` sql
SELECT product_id,
       name,
       price,
       round(price / 1.2 * 0.2, 2) as tax,
       round(price - (price / 1.2 * 0.2), 2) as price_before_tax
FROM   products
ORDER BY price_before_tax desc, product_id
```

# Подведём итоги
На этом уроке мы:

- Познакомились с операторами SELECT и FROM и научились составлять базовые запросы.
- Узнали, как сортировать записи с помощью оператора ORDER BY.
- Научились ограничивать количество выводимых записей с помощью оператора LIMIT.
- Выяснили, как преобразовывать типы данных с помощью CAST.
- Научились работать с датой и временем и познакомились с функцией DATE_PART.
- Узнали про NULL значения и поработали с COALESCE.
- Научились работать с текстовыми данными и соединять строки с помощью функции CONCAT.
- Поработали с арифметическими операторами и математическими функциями.
- Познакомились с конструкцией CASE и научились составлять комплексные логические выражения.

Известные нам на текущий момент ключевые слова и порядок их написания в запросе:
```
SELECT    -- перечисление полей результирующей таблицы
FROM      -- указание источника данных
ORDER BY  -- сортировка результирующей таблицы
LIMIT     -- ограничение количества выводимых записей
```
---
# ФИЛЬТРАЦИЯ ДАННЫХ

## Задача 1.
Задание:

Напишите SQL-запрос к таблице products и выведите всю информацию о товарах, цена которых не превышает 100 рублей. Результат отсортируйте по возрастанию id товара.

Поля в результирующей таблице: product_id, name, price


``` sql
SELECT product_id,
       name,
       price
FROM   products
WHERE  price <= 100
ORDER BY product_id
```
## Задача 2.
Задание:

Отберите пользователей женского пола из таблицы users. Выведите только id этих пользователей. Результат отсортируйте по возрастанию id.

Добавьте в запрос оператор LIMIT и выведите только 1000 первых id из отсортированного списка.

Поле в результирующей таблице: user_id


``` sql
SELECT user_id
FROM   users
WHERE  sex = 'female'
ORDER BY user_id limit 1000
```
## Задача 3.
Задание:

Отберите из таблицы user_actions все действия пользователей по созданию заказов, которые были совершены ими после полуночи 6 сентября 2022 года. Выведите колонки с id пользователей, id созданных заказов и временем их создания.

Результат должен быть отсортирован по возрастанию id заказа.

Поля в результирующей таблице: user_id, order_id, time
``` sql
SELECT user_id,
       order_id,
       time
FROM   user_actions
WHERE  time >= '2022-09-06'
   and action = 'create_order'
ORDER BY order_id
```
## Задача 4.
Задание:

Назначьте скидку 20% на все товары из таблицы products и отберите те, цена на которые с учётом скидки превышает 100 рублей. Выведите id товаров, их наименования, прежнюю цену и новую цену с учётом скидки. Колонку со старой ценой назовите old_price, с новой — new_price.

Результат должен быть отсортирован по возрастанию id товара.

Поля в результирующей таблице: product_id, name, old_price, new_price
``` sql
SELECT product_id,
       name,
       price as old_price,
       price * 0.8 as new_price
FROM   products
WHERE  price * 0.8 > 100
ORDER BY product_id
```
## Задача 5.
Задание:

Отберите из таблицы products все товары, названия которых либо начинаются со слова «чай», либо состоят из пяти символов. Выведите две колонки: id товаров и их наименования.

Результат должен быть отсортирован по возрастанию id товара.

Поля в результирующей таблице: product_id, name
``` sql
SELECT product_id,
       name
FROM   products
WHERE  split_part(name, ' ', 1) = 'чай'
    or length(name) = 5
ORDER BY product_id
```
## Задача 6.
Задание:

Отберите из таблицы products все товары, содержащие в своём названии последовательность символов «чай» (без кавычек). Выведите две колонки: id продукта и его название.

Результат должен быть отсортирован по возрастанию id товара.

Поля в результирующей таблице: product_id, name
``` sql
SELECT product_id,
       name
FROM   products
WHERE  name like '%чай%'
ORDER BY product_id
```
## Задача 7.
Задание:

Выберите из таблицы products id и наименования только тех товаров, названия которых начинаются на букву «с» и содержат только одно слово.

Результат должен быть отсортирован по возрастанию id товара.

Поля в результирующей таблице: product_id, name
``` sql
SELECT product_id,
       name
FROM   products
WHERE  name like 'с%'
   and name not like '% %'
ORDER BY product_id
```
## Задача 8.
Задание:

Составьте SQL-запрос, который выбирает из таблицы products все чаи стоимостью больше 60 рублей и вычисляет для них цену со скидкой 25%.

Скидку в % менеджер попросил указать в отдельном столбце в формате текста, то есть вот так: «25%» (без кавычек). Столбцы со скидкой и новой ценой назовите соответственно discount и new_price.

Также необходимо любым известным способом избавиться от «чайного гриба»: вряд ли менеджер имел в виду и его, когда ставил нам задачу.

Результат должен быть отсортирован по возрастанию id товара.

Поля в результирующей таблице: product_id, name, price, discount, new_price
``` sql
SELECT product_id,
       name,
       price,
       '25%' as discount,
       price * 0.75 as new_price
FROM   products
WHERE  name like '%чай%'
   and name not like 'чайный гриб'
   and price > 60
ORDER BY product_id
```
## Задача 9.
Задание:

Из таблицы user_actions выведите всю информацию о действиях пользователей с id 170, 200 и 230 за период с 25 августа по 4 сентября 2022 года включительно. Результат отсортируйте по убыванию id заказа — то есть от самых поздних действий к самым первым.

Поля в результирующей таблице: user_id, order_id, action, time
``` sql
SELECT user_id,
       order_id,
       action,
       time
FROM   user_actions
WHERE  user_id in (170, 200, 230)
   and time between '2022-08-25'
   and '2022-09-05'
ORDER BY order_id desc
```
## Задача 10.
Задание:

Напишите SQL-запрос к таблице couriers и выведите всю информацию о курьерах, у которых не указан их день рождения.

Результат должен быть отсортирован по возрастанию id курьера.

Поля в результирующей таблице: birth_date, courier_id, sex
``` sql
SELECT birth_date,
       courier_id,
       sex
FROM   couriers
WHERE  birth_date is null
ORDER BY courier_id
```
## Задача 11.
Задание:

Определите id и даты рождения 50 самых молодых пользователей мужского пола из таблицы users. Не учитывайте тех пользователей, у которых не указана дата рождения.

Поле в результирующей таблице: user_id, birth_date



``` sql
SELECT user_id,
       birth_date
FROM   users
WHERE  birth_date is not null
   and sex = 'male'
ORDER BY birth_date desc limit 50
```
## Задача 12.

Задание:

Напишите SQL-запрос к таблице courier_actions, чтобы узнать id и время доставки последних 10 заказов, доставленных курьером с id 100.

Поля в результирующей таблице: order_id, time
``` sql
SELECT order_id,
       time
FROM   courier_actions
WHERE  courier_id = 100
   and action = 'deliver_order'
ORDER BY time desc limit 10
```
## Задача 13.
Задание:

Из таблицы user_actions получите id всех заказов, сделанных пользователями сервиса в августе 2022 года.

Результат отсортируйте по возрастанию id заказа.

Поле в результирующей таблице: order_id

``` sql
SELECT order_id
FROM   user_actions
WHERE  time between '2022-08-01'
   and '2022-09-01'
   and action = 'create_order'
ORDER BY order_id
```
## Задача 14.
Задание:

Из таблицы couriers отберите id всех курьеров, родившихся в период с 1990 по 1995 год включительно.

Результат отсортируйте по возрастанию id курьера.

Поле в результирующей таблице: courier_id

``` sql
SELECT courier_id
FROM   couriers
WHERE  date_part('year', birth_date) >= 1990
   and date_part('year', birth_date) <= 1995
ORDER BY courier_id
```
## Задача 15.
Задание:

Из таблицы user_actions получите информацию о всех отменах заказов, которые пользователи совершали в течение августа 2022 года по средам с 12:00 до 15:59.

Результат отсортируйте по убыванию id отменённых заказов.

Поля в результирующей таблице: user_id, order_id, action, time

``` sql
SELECT user_id,
       order_id,
       action,
       time
FROM   user_actions
WHERE  action = 'cancel_order'
   and date_part ('dow', time) = 3
   and date_part ('month' , time) = 8
   and date_part('hour', time) between 12
   and 15
   and date_part('year', time) = 2022
ORDER BY order_id desc
```
## 

``` sql
SELECT product_id,
       name,
       price,
       case when name in ('сахар', 'сухарики', 'сушки', 'семечки', 'масло льняное', 'виноград', 'масло оливковое', 'арбуз', 'батон', 'йогурт', 'сливки', 'гречка', 'овсянка', 'макароны', 'баранина', 'апельсины', 'бублики', 'хлеб', 'горох', 'сметана', 'рыба копченая', 'мука', 'шпроты', 'сосиски', 'свинина', 'рис', 'масло кунжутное', 'сгущенка', 'ананас', 'говядина', 'соль', 'рыба вяленая', 'масло подсолнечное', 'яблоки', 'груши', 'лепешка', 'молоко', 'курица', 'лаваш', 'вафли', 'мандарины') then round(price / 1.1 * 0.1, 2)
            else round(price / 1.2 * 0.2, 2) end as tax,
       case when name in ('сахар', 'сухарики', 'сушки', 'семечки', 'масло льняное', 'виноград', 'масло оливковое', 'арбуз', 'батон', 'йогурт', 'сливки', 'гречка', 'овсянка', 'макароны', 'баранина', 'апельсины', 'бублики', 'хлеб', 'горох', 'сметана', 'рыба копченая', 'мука', 'шпроты', 'сосиски', 'свинина', 'рис', 'масло кунжутное', 'сгущенка', 'ананас', 'говядина', 'соль', 'рыба вяленая', 'масло подсолнечное', 'яблоки', 'груши', 'лепешка', 'молоко', 'курица', 'лаваш', 'вафли', 'мандарины') then round(price - (price / 1.1 * 0.1), 2)
            else round(price - (price / 1.2 * 0.2), 2) end as price_before_tax
FROM   products
ORDER BY price_before_tax desc, product_id
```
# Подведём итоги
В этом уроке мы:

- Научились фильтровать данные и применять логические выражения в блоке WHERE.
- Выяснили, что фильтрацию можно делать сразу по расчётным полям с применением функций к колонкам.
- Разобрались, как задавать шаблоны для текстовых значений с помощью оператора LIKE.
- Познакомились с операторами IN и BETWEEN.
- Узнали ещё больше о NULL значениях и научились отфильтровывать их с помощью IS NULL.
- Поработали с датами и временем и научились задавать диапазоны значений.
- Совместили новые знания с информацией из прошлого урока и решили большую задачу на CASE.
---
# АГРЕГАЦИЯ ДАННЫХ
## Задача 1.
Задание:

Выведите id всех уникальных пользователей из таблицы user_actions. Результат отсортируйте по возрастанию id.

Поле в результирующей таблице: user_id

``` sql
SELECT DISTINCT user_id
FROM   user_actions
ORDER BY user_id
```
## Задача 2.
Задание:

Примените DISTINCT сразу к двум колонкам таблицы courier_actions и отберите уникальные пары значений courier_id и order_id.

Результат отсортируйте сначала по возрастанию id курьера, затем по возрастанию id заказа.

Поля в результирующей таблице: courier_id, order_id
``` sql
SELECT DISTINCT courier_id,
                order_id
FROM   courier_actions
ORDER BY courier_id, order_id
```
## Задача 3.
Посчитайте максимальную и минимальную цены товаров в таблице products. Поля назовите соответственно max_price, min_price.

Поля в результирующей таблице: max_price, min_price

``` sql
SELECT max(price) as max_price,
       min(price) as min_price
FROM   products
```
## Задача 4.
Задание:

Как вы помните, в таблице users у некоторых пользователей не были указаны их даты рождения.

Посчитайте в одном запросе количество всех записей в таблице и количество только тех записей, для которых в колонке birth_date указана дата рождения.

Колонку с общим числом записей назовите dates, а колонку с записями без пропусков — dates_not_null.

Поля в результирующей таблице: dates, dates_not_null

``` sql
SELECT count(*) as dates,
       count(birth_date) as dates_not_null
FROM   users
```
## Задача 5.

Задача:

Посчитайте количество всех значений в колонке user_id в таблице user_actions, а также количество уникальных значений в этой колонке (т.е. количество уникальных пользователей сервиса).

Колонку с первым полученным значением назовите users, а колонку со вторым — unique_users.

Поля в результирующей таблице: users, unique_users


``` sql
SELECT count(user_id) as users,
       count(distinct user_id) as unique_users
FROM   user_actions
```
## Задача 6.
Задание:

Посчитайте количество курьеров женского пола в таблице couriers. Полученный столбец с одним значением назовите couriers.

Поле в результирующей таблице: couriers



``` sql
SELECT count(*) as couriers
FROM   couriers
WHERE  sex = 'female'
```
## Задача 7.
Задача:

Рассчитайте время, когда были совершены первая и последняя доставки заказов в таблице courier_actions.

Колонку с временем первой доставки назовите first_delivery, а колонку с временем последней — last_delivery.

Поля в результирующей таблице: first_delivery, last_delivery



``` sql
SELECT min(time) as first_delivery,
       max(time) as last_delivery
FROM   courier_actions
WHERE  action = 'deliver_order'
```
## Задача 8.

Задание:

Представьте, что один из пользователей сервиса сделал заказ, в который вошли одна пачка сухариков, одна пачка чипсов и один энергетический напиток. Посчитайте стоимость такого заказа.

Колонку с рассчитанной стоимостью заказа назовите order_price.

Для расчётов используйте таблицу products.

Поле в результирующей таблице: order_price


``` sql
SELECT sum(price) as order_price
FROM   products
WHERE  name in ('сухарики', 'чипсы', 'энергетический напиток')
```
## Задача 9.

Задание:

Посчитайте количество заказов в таблице orders с девятью и более товарами. Для этого воспользуйтесь функцией array_length, отфильтруйте данные по количеству товаров в заказе и проведите агрегацию. Полученный столбец назовите orders.

Поле в результирующей таблице: orders
``` sql
SELECT count(*) as orders
FROM   orders
WHERE  array_length(product_ids, 1) >= 9
```
## Задача 10.

Задание:

С помощью функции AGE и агрегирующей функции рассчитайте возраст самого молодого курьера мужского пола в таблице couriers.

Возраст выразите количеством лет, месяцев и дней (как в примере выше), переведя его в тип VARCHAR. 

В качестве даты, относительно которой считать возраст курьеров, используйте свою текущую дату (либо не указывайте её на месте первого аргумента, как показано в примерах).

Полученную колонку со значением возраста назовите min_age.

Поле в результирующей таблице: min_age
``` sql
SELECT age(current_date, max(birth_date))::varchar as min_age
FROM   couriers
WHERE  sex = 'male'
```
## Задача 11.

Задание:

Посчитайте стоимость заказа, в котором будут три пачки сухариков, две пачки чипсов и один энергетический напиток. Колонку с рассчитанной стоимостью заказа назовите order_price.

Для расчётов используйте таблицу products.

Поле в результирующей таблице: order_price


``` sql
SELECT sum(case when name = 'сухарики' then price * 3
                when name = 'чипсы' then price * 2
                when name = 'энергетический напиток' then price
                else 0 end) as order_price
FROM   products
```
## Задача 12.
Задание:

Рассчитайте среднюю цену товаров в таблице products, в названиях которых присутствуют слова «чай» или «кофе». Любым известным способом исключите из расчёта товары, содержащие в названии «иван-чай» или «чайный гриб».

Среднюю цену округлите до двух знаков после запятой. Столбец с полученным значением назовите avg_price.

Поле в результирующей таблице: avg_price

``` sql
SELECT round(avg(price), 2) as avg_price
FROM   products
WHERE  (name ilike '%чай%'
    or name ilike '%кофе%')
   and name not ilike '%иван-чай%'
   and name not ilike '%чайный гриб%'
```
## Задача 13.
Задание:

Воспользуйтесь функцией AGE и рассчитайте разницу в возрасте между самым старым и самым молодым пользователями мужского пола в таблице users. 

Разницу в возрасте выразите количеством лет, месяцев и дней, переведя её в тип VARCHAR. 

Колонку с посчитанным значением назовите age_diff.

Поле в результирующей таблице: age_diff

``` sql
SELECT age(max(birth_date), min(birth_date))::varchar as age_diff
FROM   users
WHERE  sex = 'male'
```
## Задача 14.
Задание:

Рассчитайте среднее количество товаров в заказах из таблицы orders, которые пользователи оформляли по выходным дням (суббота и воскресенье) в течение всего времени работы сервиса.

Полученное значение округлите до двух знаков после запятой. Колонку с ним назовите avg_order_size.

Поле в результирующей таблице: avg_order_size

``` sql
SELECT round(avg(array_length(product_ids, 1)), 2) as avg_order_size
FROM   orders
WHERE  date_part('dow', creation_time) in (6, 0)
```
## Задача 15.

Задание:

На основе данных в таблице user_actions посчитайте количество уникальных пользователей сервиса, количество уникальных заказов, поделите одно на другое и выясните, сколько заказов приходится на одного пользователя.

В результирующей таблице отразите все три значения — поля назовите соответственно unique_users, unique_orders, orders_per_user.

Показатель числа заказов на пользователя округлите до двух знаков после запятой.

Поля в результирующей таблице: unique_users, unique_orders, orders_per_user


``` sql
SELECT count(distinct user_id) as unique_users,
       count(distinct order_id) as unique_orders,
       round(count(distinct order_id)::decimal / count(distinct user_id)::decimal,
             2) as orders_per_user
FROM   user_actions
```
## * Задача 16.

Задание:

Посчитайте, сколько пользователей никогда не отменяли свой заказ. Для этого из общего числа всех уникальных пользователей отнимите число уникальных пользователей, которые хотя бы раз отменяли заказ. Подумайте, какое условие необходимо указать в FILTER, чтобы получить корректный результат.

Полученный столбец назовите users_count.

Поле в результирующей таблице: users_count
``` sql
SELECT count(distinct user_id) - count(distinct user_id) filter (WHERE action = 'cancel_order') as users_count
FROM   user_actions
```
## * Задача 17.
Задание:

Посчитайте общее количество заказов в таблице orders, количество заказов с пятью и более товарами и найдите долю заказов с пятью и более товарами в общем количестве заказов.

В результирующей таблице отразите все три значения — поля назовите соответственно orders, large_orders, large_orders_share.

Долю заказов с пятью и более товарами в общем количестве товаров округлите до двух знаков после запятой.

Поля в результирующей таблице: orders, large_orders, large_orders_share

``` sql
SELECT count(order_id) as orders,
       count(order_id) filter (WHERE array_length(product_ids, 1) >= 5) as large_orders,
       round(count(order_id) filter (WHERE array_length(product_ids, 1) >= 5) / count(order_id)::decimal,
             2) as large_orders_share
FROM   orders
```

# Подведём итоги

В этом уроке мы:

- Познакомились с ключевым словом DISTINCT.
- Разобрались, как работают агрегирующие функции SUM, MIN, MAX, COUNT.
- Узнали разницу между COUNT(*) и COUNT(column).
- Научились совмещать фильтрацию и агрегацию в одном запросе.
- Поработали с массивами и узнали, что делает функция array_length.
- Узнали ещё больше про даты и время и познакомились с функцией AGE.
- Затронули более продвинутую тему — агрегатные выражения с фильтрацией.
---
# ГРУППИРОВКА ДАННЫХ
## Задача 1. 


``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
## 

``` sql

```
